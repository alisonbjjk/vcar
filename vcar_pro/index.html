<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>VCAR PRO</title>
    <link rel="icon" type="image/x-icon" href="../apis/img/icon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/assets/css/leaflet.css" />
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
        rel='stylesheet' />
    <!-- <link rel="stylesheet" href="//norkart.github.io/Leaflet-MiniMap/Control.MiniMap.css" /> -->
    <link rel="stylesheet" href="./js/Control.MiniMap.css" />
    <!-- <link rel="stylesheet" href="https://teastman.github.io/Leaflet.pattern/leaflet.css" /> -->
    <link rel="stylesheet" href="./js/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/libs/leaflet.min.css">
    <style>
        #map {
            height: 600px;
        }

        body {
            background-image: url('https://images.pexels.com/photos/1650669/pexels-photo-1650669.jpeg');
            background-repeat: no-repeat;
            background-size: cover;
            -ms-overflow-style: none;
            /* for Internet Explorer, Edge */
            scrollbar-width: none;
            /* for Firefox */
            overflow-y: scroll;
        }

        ::-webkit-scrollbar {
            display: block;
        }

        .form-check-input {
            clear: left;
        }

        .form-switch.form-switch-md {
            margin-bottom: 1rem;
            /* JUST FOR STYLING PURPOSE */
        }

        .form-switch.form-switch-md .form-check-input {
            height: 1.5rem;
            width: calc(2rem + 0.75rem);
            border-radius: 3rem;
        }
    </style>
</head>

<body>
    <div class="d-flex justify-content-center">
        <div class="card mt-2 col-md-7 mb-4">
            <div class="card-header d-flex justify-content-center align-items-center">
                <div class="col-3 d-flex justify-content-start">
                    <a href="http://condicoesambientais.com.br">
                        <img src="../apis/img/icon.png" height="50px">
                    </a>
                </div>
                <div class="col-6 d-flex justify-content-center">
                    <h3 class="mt-2 text-success text-center text-uppercase">
                        <strong>CONDIÇÕES AMBIENTAIS PRO</strong>
                    </h3>
                </div>
                <div class="col-3 d-flex justify-content-end">
                    <img src="../apis/img/icon3.png" height="30px">
                </div>
            </div>
            <div class="card-body">
                <form class="d-flex justify-content-center" action="." id="frm" role="frm">
                    <div class="row g-3">
                        <div class="d-flex justify-content-end">
                            <div class="col-3">
                                <select class="form-select form-select-sm" id="tipoMapa">
                                    <option value="0">Open Street Map</option>
                                    <option value="1">Google Maps (Roadmap)</option>
                                    <option value="2">Google Maps (Hybrid)</option>
                                    <option value="3" selected>ESRI Satélite</option>
                                    <option value="4">CartoDB Black</option>
                                    <option value="5">Hipsométrico (Open TopoMap) </option>
                                </select>
                            </div>
                        </div>
                        <div class="my-4" id="map"></div>
                        <input type="file" id="inputFile" name="inputFile" style="display:none">
                        <div class="col-6">
                            <label for="nome" class="form-label text-uppercase">Nome <label
                                    class="text-danger">*</label></label>
                            <input type="text" class="form-control" id="nome" name="nome">
                        </div>
                        <div class="col-6">
                            <label for="email" class="form-label text-uppercase">Email <label
                                    class="text-danger">*</label></label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        <div class="col-6 mb-3">
                            <label for="processo" class="form-label text-uppercase">Nº do Processo <label
                                    class="text-danger">*</label></label>
                            <input type="text" class="form-control" id="processo" name="processo">
                        </div>
                        <hr>
                        <div class="d-flex justify-content-center">
                            <h4>CAMADAS</h4>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="processo" class="form-label text-uppercase">Tabelas de Vértices - Torna as
                                análises mais lentas <label class="text-danger">*</label></label>
                            <select id="vertices" name="vertices" class="form-select"
                                aria-label="Default select example">
                                <option selected value="Sem tabelas">Sem tabelas - Maior agilidade </option>
                                <option value="Sem formatação">Sem formatação (Excel) - Lentidão Moderada </option>
                                <option value="Formatadas">Formatadas (PDF e Excel) - Maior lentidão </option>
                            </select>
                        </div>
                        <div class="col-12 mb-3 row m-0 p-0">
                            <div class="col-6">
                                <label for="curvaNivel" class="form-label text-uppercase">Resolução das Curvas de Nível
                                    (CNs)</label>
                                <input class="form-control" type="number" step="0.1" min="0" id="curvaNivel"
                                    name="curvaNivel" value="">
                            </div>
                            <div class="col-6">
                                <label for="cota" class="form-label text-uppercase">Campo com as Cota das CNs</label>
                                <input class="form-control" type="number" step="1" min="0" id="cota" name="cota"
                                    value="">
                            </div>
                        </div>
                        <div id="camadas" class="m-0 p-0" count="1">
                            <div class="row justify-content-between align-self-center border rounded p-3 m-2" id="div-1"
                                id="1" count="1">
                                <div class="col-12 btn d-flex justify-content-end align-self-center">
                                    <button onclick="removeCamadas('1')" type="button" class="btn">
                                        <i class="fa-regular fa-trash-can fa-lg" style="color: #ff0000;"></i>
                                    </button>
                                </div>
                                <div class="col-4">
                                    <label for="nomeCamada1" class="form-label text-uppercase">Nome da camada</label>
                                    <input type="text" class="form-control" id="nomeCamada1" rows="4"
                                        placeholder="Se preferir, atribua um nome para a Camada. Por exemplo: Área de Cultivo." />
                                </div>
                                <div class="col-3">
                                    <label for="tipo1" class="form-label text-uppercase">Tipo da camada <label
                                            class="text-danger">*</label></label>
                                    <select onchange="ativaCurvaNivel(this, 1)" id="tipo1" class="form-select"
                                        aria-label="Default select example">
                                        <option value="Análise Geral" selected>Análise Geral</option>
                                        <option value="Aceiros">Aceiros</option>
                                        <option value="Aerogeradores">Aerogeradores</option>
                                        <option value="ANM">ANM</option>
                                        <option value="APPs de Declividades">APPs de Declividades</option>
                                        <option value="Curvas de Nível">Curvas de Nível</option>
                                        <option value="Declividades 25 a 44°">Declividades entre 25° e 45°</option>
                                        <option value="Empreendimento">Empreendimento</option>
                                        <option value="RLs em Condomínio">RLs em Condomínio</option>
                                        <option value="Subestação de Energia Elétrica">Subestação de Energia Elétrica
                                        </option>
                                        <option value="Supressão DVFL">DVFL</option>
                                        <option value="Supressão Estágio Avançado">Estágio Avançado</option>
                                        <option value="Supressão Estágio Inicial">Estágio Inicial</option>
                                        <option value="Supressão Estágio Médio">Estágio Médio</option>
                                        <option value="Supressão Indivíduos Arbóreos">Indivíduos Arbóreos</option>
                                    </select>
                                </div>
                                <div class="col-5">
                                    <label for="file1" class="form-label text-uppercase">arquivo (.ZIP, .KML,
                                        .KMZ)</label>
                                    <input onchange="abrirFiles(event, '1', this.files[0])" type="file"
                                        class="form-control" id="file1" accept=".kml, .zip, .kmz">
                                </div>
                            </div>
                        </div>

                        <div class="col-12 d-flex justify-content-center">
                            <button onclick="adicionarCamadas()" style="background-color: #F4EEEE;"
                                class="btn col-11 d-flex justify-content-center" type="button">
                                <i class="fa-solid fa-plus fa-lg p-2" style="color: #252525;"></i>
                            </button>
                        </div>

                        <div class="col-12">
                            <label for="check1" class="form-label text-uppercase">Privacidade, termos e condições
                                <label class="text-danger">*</label></label>
                            <div class="form-check form-switch form-switch-md d-flex align-items-center">
                                <input class="form-check-input" type="checkbox" role="switch" value="1" id="check1"
                                    name="check1">
                                <label class="form-check-label mx-2" for="check1">Sim, concordo com as <a
                                        href="https://condicoesambientais.com.br/index.php/politica-de-privacidade/"
                                        target="_blank" rel="noopener">políticas de privacidade</a> e com os <a
                                        href="https://condicoesambientais.com.br/index.php/termos-e-condicoes/"
                                        target="_blank" rel="noopener">termos e condições</a>.</label>
                            </div>
                        </div>

                        <hr />

                        <div class="col-12 d-flex justify-content-center g-recaptcha-inner mt-4">
                            <div class="g-recaptcha d-flex" data-theme=""
                                data-sitekey="6LefpFApAAAAAJF_kiNqDpyNODz6kKT5P_fZXD7l"
                                data-callback="verifyRecaptchaCallback"
                                data-expired-callback="expiredRecaptchaCallback"></div>
                            <div class="help-block with-errors"></div>
                        </div>
                        <div class="col-12 d-flex justify-content-center">
                            <button type="button" id="enviar" class="btn col-2 btn-primary">ENVIAR</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../apis/js/L.TileLayer.BetterWMS.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <!-- <script src="https://norkart.github.io/Leaflet-MiniMap/Control.MiniMap.js" crossorigin="anonymous"></script> -->
    <script src="./js/Control.MiniMap.js"></script>
    <script src="../apis/js/kmlToGeojson.js"></script>
    <script src="../apis/js/imporShp.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shapefile@0.6.6/dist/shapefile.min.js"></script>
    <script src="https://unpkg.com/leaflet.pattern@0.1.0/dist/leaflet.pattern-src.js"></script>
    <script src="../apis/js/mapaRn.js"></script>
    <script src="../apis/js/baseMapas.js"></script>
    <script src="./js/regrasMapa.js"></script>
    <script src="./js/forms.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.15.0/proj4.js"
        integrity="sha512-zlBm5j/0UjgCzqBVLkATd/2b9Yun4SzATXJ7v1T2KfjmP0iw8FUcG5mPD60SrdxU+tRkACm3IQRq55pEkp9Qow=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/terraformer@1.0.8"></script>
    <script src="https://unpkg.com/terraformer-arcgis-parser@1.0.5"></script>
    <script src="https://unpkg.com/terraformer-wkt-parser@1.1.2"></script>
    <script>

        function removeCamadas(camada) {
            $(`#div-${camada}`).remove();
            removeLayerById(`vcar${camada}`)
        }

        function removeLayerById(layerId) {
            drawnItems.eachLayer(function (layer) {
                if (layer.options && layer.options.id === layerId) {
                    drawnItems.removeLayer(layer);
                }
            });
        }

        function adicionarCamadas() {
            var count = $("#camadas").attr('count')
            var count = parseInt(count) + 1;
            $("#camadas").attr('count', count);

            $("#camadas").append(`
            <div class="row justify-content-between border rounded p-3 pt-0 m-2" id="div-${count}" value="${count}">
                <div class="col-12 btn d-flex justify-content-end align-self-center">
                    <button onclick="removeCamadas('${count}')" type="button" class="btn">
                        <i class="fa-regular fa-trash-can fa-lg" style="color: #ff0000;"></i>
                    </button>
                </div>
                <div class="col-4">
                    <label for="nomeCamada${count}" class="form-label text-uppercase">Nome da camada</label>
                    <input type="text" class="form-control" id="nomeCamada${count}" rows="4" placeholder="Se preferir, atribua um nome para a Camada. Por exemplo: Área de Cultivo." />
                </div>
                <div class="col-3">
                    <label for="tipo${count}" class="form-label text-uppercase">Tipo da camada <label class="text-danger">*</label></label>
                    <select onchange="ativaCurvaNivel(this, ${count})" id="tipo${count}" class="form-select" aria-label="Default select example">
                        <option value="Análise Geral" selected>Análise Geral</option>
                        <option value="Aceiros">Aceiros</option>
                        <option value="Aerogeradores">Aerogeradores</option>
                        <option value="ANM">ANM</option>
                        <option value="APPs de Declividades">APPs de Declividades</option>
                        <option value="Curvas de Nível">Curvas de Nível</option>
                        <option value="Declividades 25 a 44°">Declividades entre 25° e 45°</option>
                        <option value="Empreendimento">Empreendimento</option>
                        <option value="RLs em Condomínio">RLs em Condomínio</option>
                        <option value="Subestação de Energia Elétrica">Subestação de Energia Elétrica
                        </option>
                        <option value="Supressão DVFL">DVFL</option>
                        <option value="Supressão Estágio Avançado">Estágio Avançado</option>
                        <option value="Supressão Estágio Inicial">Estágio Inicial</option>
                        <option value="Supressão Estágio Médio">Estágio Médio</option>
                        <option value="Supressão Indivíduos Arbóreos">Indivíduos Arbóreos</option>
                    </select>
                </div>
                <div class="col-5">
                    <label for="file${count}" class="form-label text-uppercase">arquivos
                        georeferenciados (.ZIP, .KML, .KMZ)</label>
                    <input type="file" onchange="abrirFiles(event, '${count}', this.files[0])" class="form-control" id="file${count}" accept=".kml, .zip, .kmz">
                </div>
            </div>
            `);
        }

        function bloquear(id) {
            $(`#nomeCamada${id}`).attr("disabled", true);
            $(`#tipo${id}`).attr("disabled", true);
            $(`#file${id}`).attr("disabled", true);

            if ($(`#tipo${id}`).val() == 'Curvas de Nível') {
                $(`#curvaNivel-${id}`).attr("disabled", true);
                $(`#cota-${id}`).attr("disabled", true);
            }
        }

        function desbloquear(id) {
            $(`#nomeCamada${id}`).attr("disabled", false);
            $(`#tipo${id}`).attr("disabled", false);
            $(`#file${id}`).attr("disabled", false);

            if ($(`#tipo${id}`).val() == 'Curvas de Nível') {
                $(`#curvaNivel-${id}`).attr("disabled", false);
                $(`#cota-${id}`).attr("disabled", false);
            }
        }

        // Inicio BuscaFile
        function abrirFiles(e, id, teste) {
            bloquear(id);
            var nome = $(`#nomeCamada${id}`).val();
            var tipo = $(`#tipo${id}`).val();

            if (tipo == 'Curvas de Nível') {
                var curva = $(`#curvaNivel-${id}`).val();
                var cota = $(`#cota-${id}`).val();
            }

            for (var x in drawnItems._layers) {
                var geojson = drawnItems._layers[x].toGeoJSON();
                if (geojson.type == 'FeatureCollection') {
                    for (var x1 in geojson.features) {
                        var nome1 = geojson.features[x1].properties.nome;
                        var tipo1 = geojson.features[x1].properties.tipo;
                        if (nome1 == nome && tipo1 == tipo) {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "Não é permitido adicionar camadas com nomes e tipos duplicados!",
                            });
                            desbloquear(id)
                            $(`#file${id}`).val(null);
                            return;
                        }
                    }
                }
            }

            if (tipo == null) {
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: `Inserir Tipo da Camada.\nErro: cod(${id}).`,
                });
                desbloquear(id)
                $(`#file${id}`).val(null);
                return;
            }

            // var file = e.target.files[0];
            var file = teste;
            var nameFile = e.target.files[0].name;
            var extFile = nameFile.split('.').pop().toLowerCase();
            var fr = new FileReader();

            var geojson = {
                type: "FeatureCollection",
                id: id,
                features: [],
            }

            fr.onload = function (event) {
                if (extFile == 'kml') {
                    var kmlImport = toGeoJSON.kml(new DOMParser().parseFromString(fr.result, "text/xml"));
                    var arr = kmlImport.features;
                    for (var i = 0; i < arr.length; i++) {
                        arr[i].properties.id = id
                        arr[i].properties.tipo = tipo
                        arr[i].properties.nome = nome
                        if (tipo == 'Curvas de Nível') {
                            arr[i].properties.curva = curva;
                            arr[i].properties.cota = cota;
                        }
                        if (!arr[i].properties.fill) {
                            arr[i].properties.fill = "#008000";
                            arr[i].properties.stroke = "#008000";
                            arr[i].properties['stroke-width'] = 2;
                            arr[i].properties['stroke-opacity'] = 1;
                            arr[i].properties['fill-opacity'] = 0.3;
                        }
                        if (arr[i].geometry.type == "Polygon") {
                            arr[i].properties['hachura'] = "Não";
                            arr[i].properties['angulo'] = 45;
                            arr[i].properties['largura'] = 4;
                        }
                        geojson.features.push(arr[i]);
                    }
                    montarLayer(geojson, id);
                } else if (extFile == 'kmz') {
                    const kmzFile = file;
                    const jszip = new JSZip();
                    jszip.loadAsync(kmzFile)
                        .then(function (zip) {
                            // Encontre o arquivo KML dentro do KMZ
                            const kmlFile = zip.file(/\.kml$/i); // Normalmente, há um único arquivo KML no KMZ
                            if (kmlFile.length === 0) {
                                console.error("Não foi encontrado nenhum arquivo KML no KMZ");
                                desbloquear(id)
                                $(`#file${id}`).val(null);
                                return;
                            }

                            // Extrair o conteúdo do arquivo KML
                            kmlFile[0].async('string')
                                .then(function (kmlData) {
                                    // Converter o KML para GeoJSON usando togeojson
                                    const kml = new DOMParser().parseFromString(kmlData, 'text/xml');
                                    const geojson = toGeoJSON.kml(kml); // Converte KML para GeoJSON

                                    geojson.features.forEach(function (feature) {
                                        feature.properties.id = id;
                                        feature.properties.tipo = tipo;
                                        feature.properties.nome = nome;
                                        if (tipo == 'Curvas de Nível') {
                                            feature.properties.curva = curva;
                                            feature.properties.cota = cota;
                                        }
                                        if (!feature.properties.fill) {
                                            feature.properties.fill = "#008000";
                                            feature.properties.stroke = "#008000";
                                            feature.properties['stroke-width'] = 2;
                                            feature.properties['stroke-opacity'] = 1;
                                            feature.properties['fill-opacity'] = 0.3;
                                        }
                                        if (feature.geometry.type == "Polygon") {
                                            arr[i].properties['hachura'] = "Não";
                                            feature.properties['angulo'] = 45;
                                            feature.properties['largura'] = 4;
                                        }
                                    });

                                    montarLayer(geojson, id);
                                    // Aqui você pode fazer o que quiser com o GeoJSON (exibir no mapa, etc.)
                                })
                                .catch(function (err) {
                                    desbloquear(id)
                                    $(`#file${id}`).val(null);
                                    console.error('Erro ao processar o arquivo KML:', err);
                                });
                        })
                        .catch(function (err) {
                            desbloquear(id)
                            $(`#file${id}`).val(null);
                            console.error('Erro ao descompactar o KMZ:', err);
                        });
                } else if (extFile == 'zip') {

                    var zip = new JSZip();

                    try {
                        zip.loadAsync(file)
                            .then(async function (zip) {
                                const shpFiles = [];
                                const dbfFiles = [];
                                const prjFiles = {};

                                // Função recursiva para processar arquivos dentro do ZIP
                                async function processZipContent(currentZip, basePath = '') {
                                    const zipEntries = Object.keys(currentZip.files);

                                    for (const relativePath of zipEntries) {
                                        const file = currentZip.files[relativePath];
                                        const fullPath = basePath + relativePath;

                                        if (file.dir) {
                                            // Caso seja uma pasta, processar recursivamente
                                            continue;
                                        } else if (relativePath.endsWith('.zip')) {
                                            // Caso seja um ZIP dentro do ZIP, processar recursivamente
                                            const innerZipData = await file.async('arraybuffer');
                                            const innerZip = await JSZip.loadAsync(innerZipData);
                                            await processZipContent(innerZip, `${fullPath}/`);
                                        } else if (relativePath.endsWith('.shp')) {
                                            shpFiles.push({ file, fullPath });
                                        } else if (relativePath.endsWith('.dbf')) {
                                            dbfFiles.push({ file, fullPath });
                                        } else if (relativePath.endsWith('.prj')) {
                                            const baseName = relativePath.split('.').slice(0, -1).join('.');
                                            prjFiles[baseName] = { file, fullPath };
                                        }
                                    }
                                }

                                // Processar todo o conteúdo do ZIP principal
                                await processZipContent(zip);

                                if (!shpFiles.length || !dbfFiles.length) {
                                    Swal.fire({
                                        icon: "error",
                                        title: "Oops...",
                                        text: 'Nenhum conjunto SHP/DBF válido encontrado',
                                    });
                                    desbloquear(id)
                                    $(`#file${id}`).val(null);
                                    return;
                                }

                                // Processar cada conjunto SHP/DBF
                                for (const { file: shpFile, fullPath: shpPath } of shpFiles) {
                                    const baseName = shpPath.split('.').slice(0, -1).join('.');
                                    const dbfEntry = dbfFiles.find(({ fullPath }) => fullPath.startsWith(baseName));
                                    const prjEntry = prjFiles[baseName] || null;

                                    if (!dbfEntry) {
                                        desbloquear(id)
                                        $(`#file${id}`).val(null);
                                        console.warn(`Arquivo DBF correspondente não encontrado para ${shpPath}`);
                                        continue;
                                    }

                                    try {
                                        await processFileSet(shpFile, dbfEntry.file, prjEntry ? prjEntry.file : null, id);
                                    } catch (error) {
                                        desbloquear(id)
                                        $(`#file${id}`).val(null);
                                        console.error(`Erro ao processar arquivos do conjunto ${baseName}:`, error);
                                    }
                                }
                            })
                            .catch(error => {
                                desbloquear(id)
                                $(`#file${id}`).val(null);
                                console.error('Erro ao ler arquivo ZIP:', error);
                            });
                    } catch (error) {
                        desbloquear(id)
                        $(`#file${id}`).val(null);
                        console.error('Erro ao carregar o arquivo ZIP:', error);
                    }

                    // Função para processar um conjunto de arquivos SHP/DBF/PRJ
                    async function processFileSet(shpFile, dbfFile, prjFile, id) {
                        const shpData = new Uint8Array(await shpFile.async('arraybuffer'));
                        const dbfData = new Uint8Array(await dbfFile.async('arraybuffer'));
                        const prjData = prjFile ? await prjFile.async('string') : null;

                        let geojson = shp.combine([
                            shp.parseShp(shpData),
                            shp.parseDbf(dbfData)
                        ]);

                        if (prjData) {
                            const sourceProjection = proj4(prjData.trim());
                            const wgs84 = proj4('EPSG:4326');
                            geojson.features.forEach(feature => {
                                if (feature.geometry && feature.geometry.coordinates) {
                                    feature.geometry.coordinates = reprojectCoordinates(
                                        feature.geometry.coordinates,
                                        sourceProjection,
                                        wgs84
                                    );
                                }
                            });
                        }

                        enhanceFeatures(geojson.features);
                        montarLayer(geojson, id);
                    }

                    // Função para melhorar as propriedades dos recursos GeoJSON
                    function enhanceFeatures(features) {
                        features.forEach(feature => {
                            if (tipo == 'Curvas de Nível') {
                            } else {
                                curva = ''
                                cota = ''
                            }
                            feature.properties = {
                                ...feature.properties,
                                id: id,
                                tipo: tipo,
                                nome: nome,
                                curva: curva,
                                cota: cota,
                                fill: feature.properties.fill || "#008000",
                                stroke: feature.properties.stroke || "#008000",
                                'stroke-width': 2,
                                'stroke-opacity': 1,
                                'fill-opacity': 0.3,
                                angulo: 45,
                                largura: 4,
                                hachura: feature.geometry.type === "Polygon" ? "Não" : undefined
                            };
                        });
                    }

                    // Função para reprojetar coordenadas
                    function reprojectCoordinates(coords, sourceProj, targetProj) {
                        if (!Array.isArray(coords[0])) {
                            return proj4(sourceProj, targetProj, coords);
                        } else {
                            return coords.map(innerCoords => reprojectCoordinates(innerCoords, sourceProj, targetProj));
                        }
                    }



                } else {
                    desbloquear(id)
                    $(`#file${id}`).val(null);
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "Inserir Arquivo do tipo GEOREFERENCIADOS(.ZIP e/ou .KML)!",
                    });
                }
            }
            fr.readAsText(e.target.files[0]);
        }
        // Fim BuscaFile

        // Função para reprojetar coordenadas
        function reprojectCoordinates(coords, sourceProj, targetProj) {
            if (!Array.isArray(coords[0])) {
                return proj4(sourceProj, targetProj, coords);
            } else {
                return coords.map(function (innerCoords) {
                    return reprojectCoordinates(innerCoords, sourceProj, targetProj);
                });
            }
        }

        // Montar Layers Geojson
        function montarLayer(geojson, id) {
            var geojsonLayer = L.geoJSON(geojson, {
                id: `vcar${id}`
            }).addTo(drawnItems);

            geojsonLayer.eachLayer(function (layer) {
                feature = layer.feature
                if (feature.properties['fill']) {
                    feature.properties['fill-opacity'] ? fillOpacity = feature.properties['fill-opacity'] : fillOpacity = feature.properties['fill-opa'];
                    feature.properties['stroke-opacity'] ? strokeOpacity = feature.properties['stroke-opacity'] : strokeOpacity = feature.properties['stroke-o'];
                    feature.properties['stroke-width'] ? strokeWidth = feature.properties['stroke-width'] : strokeWidth = feature.properties['stroke-w'];
                    feature.properties['hachura'] ? hachura = feature.properties['hachura'] : hachura = feature.properties['hachura'];
                    feature.properties['angulo'] ? angulo = feature.properties['angulo'] : angulo = feature.properties['angulo'];
                    feature.properties['largura'] ? largura = feature.properties['largura'] : largura = feature.properties['largura'];

                    if (feature.geometry.type != 'Point') {
                        layer.setStyle({
                            fillColor: feature.properties['fill'],
                            fillOpacity: fillOpacity,
                            color: feature.properties.stroke,
                            width: strokeWidth,
                            opacity: strokeOpacity,
                        })
                    }
                }

                type = feature.geometry.type;

                var popupContent = `<table id="table_${feature.properties.id}" class="table table-striped table-bordered p-0 m-0" style="width:100%">`;
                for (var prop in feature.properties) {
                    if (prop != 'id') {
                        if (prop == 'stroke' || prop == 'fill') {
                            popupContent += `<tr><td>${prop}</td><td><input type="color" id="${prop}" name="${prop}" style="width: 100%; height: 15px;" value="${feature.properties[prop]}" id="${prop}"/></td></tr>`;

                        } else if (prop == 'nome' || prop == 'tipo') {
                            popupContent += `<tr><td>${prop}</td><td><input type="text" disabled name="${prop}" value="${feature.properties[prop]}" /></td></tr>`;

                        } else if (prop == 'stroke-width' || prop == 'stroke-opacity' || prop == 'fill-opacity') {
                            popupContent += `<tr><td>${prop}</td><td><input type="number" step="0.1" name="${prop}" value="${feature.properties[prop]}" /></td></tr>`;

                        } else if (prop == 'angulo') {
                        } else if (prop == 'largura') {
                        } else if (prop == 'hachura' && type == 'Polygon') {
                            if (feature.properties[prop] == 'Não') {
                                popupContent += `<tr><td>${prop}</td><td>

                                    <select onchange="ativaHachura(this, ${feature.properties.id}, ${feature.properties.angulo}, ${feature.properties.largura});" class="form-control form-select-sm" id="hachura_${feature.properties.id}" name='hachura_${feature.properties.id}'>
                                        <option value='Sim'>Sim</option>
                                        <option value='Não' selected>Não</option>
                                    </select>                                    
                                    </td></tr>`;
                            } else {
                                popupContent += `<tr><td>${prop}</td><td>
                                        <select onchange="ativaHachura(this, ${feature.properties.id}, ${feature.properties.angulo}, ${feature.properties.largura});" class="form-control form-select-sm" id="hachura_${feature.properties.id}" name='hachura_${feature.properties.id}'>
                                            <option value='Sim' selected>Sim</option>
                                            <option value='Não'>Não</option>
                                        </select>                                    
                                    </td></tr>`;
                            }
                        } else if (prop == 'nome' || prop == 'tipo') {
                            popupContent += `<tr><td>${prop}</td><td><input type="text" disabled name="${prop}" value="${feature.properties[prop]}" /></td></tr>`;
                        } else {
                            popupContent += ``;
                        }
                    }
                }
                popupContent += `
                    </table><hr>
                    <div class="row p-0 m-0">
                        <button type="button"  onclick="testeform(this, ${feature.properties.id})" class="btn btn-primary col mx-1">Salvar</button>
                        <button type="button" onclick="map.closePopup()" class="btn btn-sm btn-secondary col mx-1">Cancelar</button>
                    </div> 
                `;

                layer.bindPopup(popupContent, { minWidth: 200, maxWidth: 300 });
            });

            var bounds = geojsonLayer.getBounds();
            map.fitBounds(bounds);
            var center = bounds.getCenter();
            map.panTo(center);
        }

        function ativaCurvaNivel(element, id) {
            const value = element.value;
            if (value == 'Curvas de Nível') {
                $(`#div-${id}`).append(`                   
                <div class="col-12 mb-3 mt-2 row m-0 p-0" id="divCurva-${id}">
                    <div class="col-6">
                        <label for="curvaNivel" class="form-label text-uppercase">Curvas de Nível
                            (CNs)</label>
                        <input class="form-control" type="number" step="0.1" min="0" id="curvaNivel-${id}"
                            name="curvaNivel-${id}" value="">
                    </div>
                    <div class="col-6">
                        <label for="cota" class="form-label text-uppercase">Cota das CNs</label>
                        <input class="form-control" type="number" step="1" min="0" id="cota-${id}" name="cota-${id}"
                            value="">
                    </div>
                </div>`);
            } else {
                $(`#divCurva-${id}`).remove();
            }
        }


        function ativaHachura(element, id, angulo, largura) {
            const value = element.value;

            angulo == undefined ? 0 : angulo;
            angulo

            if (element.value == 'Sim') {
                for (let i = 0; i < 2; i++) {
                    const currentRow = element.closest('tr');
                    const newRow = document.createElement('tr');

                    const cell1 = document.createElement('td');
                    const cell2 = document.createElement('td');
                    if (i == 0) {
                        cell1.innerHTML = 'Ângulo';
                        cell2.innerHTML = `<input type="number" step="0.1" id="angulo_${id}" name="angulo" value="${angulo}" />`;
                    }
                    else if (i == 1) {
                        cell1.innerHTML = 'Largura Hachura';
                        cell2.innerHTML = `<input type="number" step="0.1" id="largura_${id}" name="largura" value="${largura}" />`;

                    }
                    newRow.appendChild(cell1);
                    newRow.appendChild(cell2);

                    currentRow.parentNode.insertBefore(newRow, currentRow.nextSibling);
                }
            }
        }

        function testeform(select, id) {
            var inputs = document.querySelectorAll(`#table_${id} input`);
            var hachuraValor = $(`#hachura_${id}`).find(":selected").val();
            // var 
            var dataObject = {};

            // Itera sobre os inputs e coleta os valores
            inputs.forEach(input => {
                dataObject[input.name] = input.value; // Usa o name como chave
            });


            if (hachuraValor == 'Sim') {
                var hachura = new L.StripePattern({
                    angle: dataObject['angulo'],
                    weight: dataObject['largura'],
                    color: dataObject['fill'],
                    opacity: dataObject['fill-opacity'],
                });
                hachura.addTo(map);
            } else {
                var hachura = null;
            }

            var newStyle = {
                color: dataObject['stroke'],
                weight: dataObject['stroke-width'],
                opacity: dataObject['stroke-opacity'],
                fillColor: dataObject['fill'],
                fillOpacity: dataObject['fill-opacity'],
                fillPattern: hachura
            }

            // Modificar style
            drawnItems.eachLayer(function (layer) {
                if (layer.options.id === `vcar${id}`) {
                    layer.setStyle(newStyle);
                    layer.eachLayer(function (layer) {
                        feature = layer.feature
                        feature.properties['stroke'] = newStyle.color;
                        feature.properties['stroke-width'] = newStyle.weight;
                        feature.properties['stroke-opacity'] = newStyle.opacity;
                        feature.properties['fill'] = newStyle.fillColor;
                        feature.properties['fill-opacity'] = newStyle.fillOpacity;
                        feature.properties['hachura'] = hachuraValor;
                        feature.properties['angulo'] = dataObject['angulo'] == undefined ? feature.properties['angulo'] : dataObject['angulo'];
                        feature.properties['largura'] = dataObject['largura'] == undefined ? feature.properties['largura'] : dataObject['largura'];
                        attPopUp(layer, feature)
                    });
                }
            });

        }

        function attPopUp(layer, feature) {
            type = feature.geometry.type;

            var popupContent = `<table id="table_${feature.properties.id}" class="table table-striped table-bordered p-0 m-0" style="width:100%">`;
            for (var prop in feature.properties) {
                if (prop != 'id') {
                    if (prop == 'stroke' || prop == 'fill') {
                        popupContent += `
                            <tr>
                                <td>${prop}</td>
                                <td>
                                    <input type="color" id="${prop}" name="${prop}" style="width: 100%; height: 15px;" value="${feature.properties[prop]}" id="${prop}"/>
                                    </td>
                            </tr>`;
                    } else if (prop == 'nome' || prop == 'tipo') {
                        popupContent += `<tr><td>${prop}</td><td><input type="text" disabled name="${prop}" value="${feature.properties[prop]}" /></td></tr>`;
                    } else if (prop == 'stroke-width' || prop == 'stroke-opacity' || prop == 'fill-opacity') {
                        popupContent += `<tr><td>${prop}</td><td><input type="number" step="0.1" name="${prop}" value="${feature.properties[prop]}" /></td></tr>`;
                    } else if (prop == 'angulo' && feature.properties.hachura == 'Sim' && type == 'Polygon') {

                        popupContent += `<tr><td>${prop}</td><td><input type="number" step="1.0" name="${prop}" value="${feature.properties[prop]}" /></td></tr>`;
                    } else if (prop == 'angulo' && feature.properties.hachura == 'Não' && type == 'Polygon') {

                    } else if (prop == 'largura' && feature.properties.hachura == 'Sim' && type == 'Polygon') {

                        popupContent += `<tr><td>${prop}</td><td><input type="number" step="1.0" name="${prop}" value="${feature.properties[prop]}" /></td></tr>`;
                    } else if (prop == 'largura' && feature.properties.hachura == 'Não' && type == 'Polygon') {

                    } else if (prop == 'hachura' && type == 'Polygon') {
                        if (feature.properties[prop] == 'Não') {
                            popupContent += `<tr><td>${prop}</td><td>
                                    <select onchange="ativaHachura(this, ${feature.properties.id}, ${feature.properties.angulo}, ${feature.properties.largura});" class="form-control form-select-sm" id="hachura_${feature.properties.id}" name='hachura_${feature.properties.id}'>
                                        <option value='Sim'>Sim</option>
                                        <option value='Não' selected>Não</option>
                                    </select>                                    
                                    </td></tr>`;
                        } else {
                            popupContent += `<tr><td>${prop}</td><td>
                                        <select onchange="ativaHachura(this, ${feature.properties.id}, ${feature.properties.angulo}, ${feature.properties.largura});" class="form-control form-select-sm" id="hachura_${feature.properties.id}" name='hachura_${feature.properties.id}'>
                                            <option value='Sim' selected>Sim</option>
                                            <option value='Não'>Não</option>
                                        </select>                                    
                                    </td></tr>`;
                        }
                    } else if (prop == 'nome' || prop == 'tipo') {
                        popupContent += `<tr><td>${prop}</td><td><input type="text" disabled name="${prop}" value="${feature.properties[prop]}" /></td></tr>`;
                    } else {
                        popupContent += ``;
                    }
                }
            }
            popupContent += `
                </table>
                <hr>
                    <div class="row p-0 m-0">
                        <button type="button"  onclick="testeform(this, ${feature.properties.id})" class="btn btn-primary col mx-1">Salvar</button>
                        <button type="button" onclick="map.closePopup()" class="btn btn-sm btn-secondary col mx-1">Cancelar</button>
                    </div> 
                `;
            layer.bindPopup(popupContent);
            setTimeout(() => {
                layer.openPopup();
            }, "10");
        }

    </script>
</body>

</html>